{"type":"pattern","name":"CLI Command Structure","description":"All commands live in src/commands/{name}.ts. Each exports an async function matching the command name. CLI router in src/index.ts dispatches based on argv. Commands use Bun.spawn for subprocess calls. All state in .overstory/ directory.","classification":"foundational","recorded_at":"2026-02-12T15:18:26.091Z","tags":["commands","cli","structure"],"id":"mx-97add4"}
{"type":"pattern","name":"CLI command pattern with flag parsing","description":"All commands export an async function taking args: string[]. Use getFlag(args, '--name') for valued flags and hasFlag(args, '--json') for booleans. Use process.stdout.write (not console.log) for output. Wrap in try/finally to close DB stores. Use ValidationError for bad input, domain-specific errors (AgentError, MailError, MergeError) for operation failures.","classification":"tactical","recorded_at":"2026-02-12T15:40:08.301Z","tags":["cli","commands","patterns"],"id":"mx-4cd4ed"}
{"type":"failure","description":"Claude Code hooks require ALL hook types (SessionStart, Stop, PreCompact) to use {matcher, hooks} wrapper format. Flat [{type, command}] arrays cause validation error, blocking agent startup.","resolution":"Fixed template and init fallback to wrap all hook types in {matcher: '', hooks: [...]} format. Also: must run 'bun link' so overstory CLI is in PATH for tmux-spawned agents.","classification":"tactical","recorded_at":"2026-02-12T16:07:30.473Z","id":"mx-5771cb"}
{"type":"pattern","name":"Integration testing workflow for CLI","description":"Install via 'bun link', test CLI commands systematically (help, flags, edge cases, error handling), use beads to track bugs found. Key areas to test: flag validation, error messages, state management (sessions.json), cross-component interactions (sling->worktree->tmux->hooks), and cleanup.","classification":"tactical","recorded_at":"2026-02-12T16:24:18.520Z","id":"mx-9c57b2"}
{"type":"failure","description":"tmux list-sessions #{pid} returns the tmux server PID, shared across all sessions (e.g. 55777 for everything).","resolution":"Use tmux list-panes -t <session> -F '#{pane_pid}' to get the actual process PID running inside a specific pane.","classification":"tactical","recorded_at":"2026-02-12T16:29:38.254Z","id":"mx-17ef66"}
{"type":"pattern","name":"Help flag pattern for CLI commands","description":"Add a const HELP string above the export function, then check args.includes('--help') || args.includes('-h') as the first thing in the command function and return early after printing. Consistent across all 10 subcommands.","classification":"tactical","recorded_at":"2026-02-12T16:32:44.003Z","id":"mx-d1f655"}
{"type":"convention","content":"Version lives in two places: package.json (version field) and src/index.ts (const VERSION). Use 'bun run version:bump <major|minor|patch>' to update both atomically. GitHub Actions auto-tag workflow verifies they match before creating a tag.","classification":"tactical","recorded_at":"2026-02-12T16:33:49.171Z","id":"mx-48f4ae"}
{"type":"convention","content":"biome check runs in CI on all files including .overstory/ JSON configs. These files must use tab indentation and compact array formatting to pass. Run 'biome check --write' on generated config files before committing.","classification":"tactical","recorded_at":"2026-02-12T16:39:59.746Z","id":"mx-902c66"}
{"type":"convention","content":"Validate external references (branches, file paths) early in CLI commands before passing them to subsystem functions. Use git rev-parse --verify refs/heads/<branch> for branch existence checks and Bun.file().exists() for file path checks. Throw ValidationError with field and value context for user-friendly messages instead of letting raw subprocess errors propagate.","classification":"tactical","recorded_at":"2026-02-12T16:43:27.724Z","id":"mx-8fa3eb"}
{"type":"pattern","name":"capabilityIndex must be populated at generation time","description":"When init.ts generates agent-manifest.json, it must build capabilityIndex from agent definitions — not leave it empty. The manifest loader rebuilds it at load time, but the persisted file should be correct for external tools or humans reading it. Build the index inline using the same loop pattern as manifest.ts buildCapabilityIndex.","classification":"tactical","recorded_at":"2026-02-12T16:47:31.208Z","id":"mx-05e7ca"}
{"type":"pattern","name":"Init must generate its own hooks.json, not read agent template","description":"The hooks.json.tmpl template contains {{AGENT_NAME}} placeholders for per-agent deployment. The init command should generate orchestrator hooks.json independently with tab indentation matching Biome config.","classification":"tactical","recorded_at":"2026-02-12T17:51:21.532Z","evidence":{"issue":"overstory-lmo"},"id":"mx-daeb1e"}
{"type":"convention","content":"After beads.show(), sling checks that status is 'open' or 'in_progress'. Closed/resolved issues are rejected with ValidationError to prevent wasted agent spawns on completed work.","classification":"tactical","recorded_at":"2026-02-12T17:51:22.902Z","evidence":{"issue":"overstory-cz8"},"id":"mx-909892"}
{"type":"pattern","name":"JSON output exclusivity","description":"JSON output flag pattern: use if/else with args.includes('--json') — JSON branch outputs only JSON, else branch outputs only human-readable. Check args parameter (not process.argv) for consistency with how other flags are parsed in the same command function. See status.ts as the canonical example.","classification":"tactical","recorded_at":"2026-02-12T17:56:03.045Z","id":"mx-09fa87"}
{"type":"pattern","name":"watch --background daemonization","description":"watch --background: use Bun.spawn detached to daemonize, write PID to .overstory/watchdog.pid, check for existing PID before spawning. Foreground mode also writes PID file and cleans it up on SIGINT. Child process is spawned with stdio ignore and unref() so parent can exit.","classification":"tactical","recorded_at":"2026-02-12T17:57:06.266Z","id":"mx-9db97d"}
